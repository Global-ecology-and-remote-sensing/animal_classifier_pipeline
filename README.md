# Animal Classifier HK 

[//]: # Brief overview on what the package does

Camera traps are cameras with a motion sensor that take a picture
whenever something moves in front of them. They are often
used as an inexpensive and noninvasive method of observing animals 
in the wild, however they do have one major drawback. As they are
triggered by any movement, wind and changes in lighting can
severly clutter databases with images that do not have any animal.

This package provides an easy-to-use function that identifies the 
species of the animals that were detected by MegaDetector and sorts 
them into folders by species. 
It was originally designed to work for a model that
was trained to categorise animals found in Hong Kong, however it should be easy
to adapt it for any model trained with Keras 
(see [the 'modify pipeline' section](#how-to-modify-package-for-new-model) 
for details).

## How to run the animal classifier

This package can be installed locally using PIP. To do so, download 
the github repository and run the following code, where the folder
given by "path\to\package" should contain the setup.py file

```python
pip install "path\to\package"
```

The other sections of this ReadMe file describe in detail the different
options that you have when running the program. However, if you just
want to quickly get something to work then they can all be safely ignored
and you can just run the following code once the package has been installed.
Although, you will need to download the trained model and have ran MegaDetector
as described in the [Inputs](#inputs) section.

```python
from classify_animals.main import main as classy_func

classy_func(
    bb_results_path = 'path\to\MegaDetector\output\json\string', 
    image_dir = 'path\to\raw\images',
    model_path = 'path\to\trained\model'
)
```

### Inputs

The program requires the following three files/directories to run.

- **Bounding boxes** - These are the animal detections that were found
    after running MegaDetector. (See [this section](#megadetector)
    to find out how to get this).
- **Images** - Uncropped images that were fed into
	MegaDetector. The path passed into the classification function
	should be the same as what was passed into MegaDetector's detection
	function when the bounding boxes were generated.
- **Model** - Model that was trained to classify cropped images of animals.
    It should be saved using either Keras's H5 format or some other format
	that can be read by Keras's 'model.load_model' function

#### Model

To obtain a copy of the trained model, please contact Dr. **insert name here** of the Global Ecology 
Lab at the University of Hong Kong at **his/her** email address, **insert email address**. If you
wish you your own animal classifier and wish to use this pipeline for sorting
files then please see [the modify pipeline section](#how-to-modify-package-for-new-model)
before you use your own model.

#### MegaDetector

MegaDetector is an algorithm developed by Microsoft that can automatically
detect and draw a bounding box around an animal in an image.
The function requires bounding boxes generated by MegaDetector
in order to run. Instructions on how to install and run MegaDetector can be found on
their [GitHub](https://github.com/microsoft/CameraTraps/blob/main/megadetector.md) 
page. 

This program was tested on outputs from MegaDetector v5.0A (MDv5a) and thus
may not work for other version of MegaDetector. Additionally, the
detector requires the installation of Anaconda and the packages, YOLOv5
and ai4eutils, however details of that can be found on their guide.

It should be noted that the animal detector is already
very good at removing empty images and that you but to make use of those detections
by cropping and sorting those files, this program can prove to be useful.

### Outputs

This program has two outputs. The first is a CSV file called 'Animal Labels'
that lists the species of animal detected for each image. The data
dictionary for this file is as follows:

- **original_image_path** - File path of the original uncropped image
    relative to the directory that was passed into 'image_dir'
- **cropped_image_path** - File path to the cropped image relative to
    the folder called 'cropped_images'
- **bb_conf** - Confidence level of bounding box of the animal given
    by Megadetector
- **species** - Species of the animal as predicted by the model
- **class_ent** - Level of uncertainty in the model's prediction for
    the species of the animal

The second is a folder called 'cropped_images' that contains the cropped
images of animals. It contains a subfolder for each species that was
detected by the algorithm. Additionally, if a threshold value for the
level of uncertainty in the species classifications then it will also 
contain a subfolder called "zz_unknown" for the animals that it could
not classify.

Given as is, the function is designed to classify animals into only 1 of 15
different species, but it can be modified to include any number of categories
as long as the output of a neural network is given by the node with the
highest value. 

#### Output folder

The function will create a folder within which all of the intermediary files
that are required to process the data as well as both final outputs will be stored.
All intermediary files will be deleted once the program has processed all of the
data.

By default, the folder will be created in the working directory and be called
"Animal Detections". To change where the output is stored then provide
the path to the directory by using the optional parameter 'working_data_dir'
of the function.

**Warning** please do not open, move or delete any files in
this directory while the program is still running as this will likely cause
it to crash.

#### Animal Categories

The program will classify animals into one of 15 categories
all of which can be found in Hong Kong. These are:

- Bird
- Canis lupus familiaris
- Eurasian Otter 
- Felis catus
- Herpestes javanicus
- Hystrix brachyura
- Macaca mulatta
- Melogale species
- Muntiacus species
- Other animal
- Paguma larvata
- Prionailurus bengalensis
- Rodent
- Sus scrofa
- Viverricula indica

## Optional Parameters

[//]: # Batch sizes
[//]: # Warn that if keep_crops = False then if more than one
[//]: # animal is detected in an image then there will be no
[//]: # way of knowing which label refers to which animal

The following are optional parameters of the main function
that affect the efficiency and effectiveness of the classifier.

-working_data_dir (String or Python PATH object), default None : Path
	to directory that will contain the temporary files
	the program needs to use to run and the output of
	the program. if set to None, it will default to saving
	the output to a folder that lies in the working directory
	
-keep_crops (Bool), default True : If True, MegaDetector's animal detections
	will be cropped and saved to the working data directory. Furthermore,
	the crops will be sorted by the species that the neural network
	detected them to be.
	
-md_thr (float), default 0.2 : Threshold value for the confidence ratings of
	Megadetector's detections. Only bounding boxes with a confidence
	rating above the threshold will be cropped and analysed. A higher
	threshold means that detections are more likely to be of an animal
	but it also makes it more likely that fewer animals will be detected
	
-ent_thr (float), default positive infinity : Threshold value for confidence rating in neural network's
	classifications. Confidence rating is Shannon Entropy of the network's
	output and therefore only classifcations that have an entropy below the 
	threshold will be assigned to their crops. A lower threshold will increase
	the precision of the classifier however it also means that more animal
	detections will be labelled as having an unknown species. If an entropy
	threshold is used then a cut-off of 1.0 might be a good value to start at
	although this hasn't been properly tested.
	
-batch_size (int), default 32 : Number of images to process at a time. Lowering this number
	should reduce the program's requirement for memory and storage space. Raising
	this should will likely reduce the overall time it takes for the neural network
	to process the images

-classifier_batch_size (int), default batch_size / 2 : Batch size for images as they're processed by the
	neural network classifier. By default, its half of the batch size of the cropping
	algorithm rounded up to the nearest integer. Classifier_batch_size should be at
	most batch_size

-use_checkpoints (Bool), default True: If True, the program will start from checkpoints found
	in working_data_dir, which is useful if program stops during processing. If
	False, the program will start the whole process from scratch and overwrite
	checkpoints
	
- show_progress_bar (Bool), default True: If True, a progress bar will be displayed

## How to modify the package for new model

Even if you do not use the model that can be provided by 
[Dr. **Insert Name Here**](#model), the function can still be
useful as a pipeline for extracting and analysing animal detections
from MegaDetector. The package has been designed so that it can
be tailored to work for any model that is similar to the original
one by running several commands before the function is run. Although,
it does assume that it is a Keras neural network with exactly one
output node per category and where node with the highest output
is taken as the classification.

There are several global variables that will likely need to be
changed to fit a new model. These variables can be accessed
using the "config" module and an example of which can be seen below.

```python
from classify_animals.main import main as classy_func
from classify_animals.scripts import config

config.IMAGE_SIZE = (100, 100) # Size of model's input images

classy_func(
    bb_results_path = 'path\to\MegaDetector\output\json\string', 
    image_dir = 'path\to\raw\images',
    model_path = 'path\to\trained\model'
)
```

Any changes to the global variables must be called before the
main function is executed, otherwise they will not take effect.
The global variables that can be edited by the config module are
given by:

- IMAGE_SIZE, 2-tuple of integers - Images are resized to this size
	using bilinear interpolation before being passed to the model.
	Size is measured in pixels and is given by (height, width).
- UNKNOWN_SPECIES_NAME, string - Label that should be assigned to
	the image when the classifier does not know its category (i.e.
	when the entropy of the output is above the threshold). 
	Defaults to 'zz_unknown'.
- SPECIES_CATEGORIES, 1-D NumPy array - Categories that animals
	can be classified into. Must be listed in the same order as
	when the model was trained. Should also be the same length 
	as the number of output nodes in the model
- WORK_DIR_DEFAULT_NAME, string - Default name for program's
	working directory folder when no directory is supplied to
	the program
- The following global variableas are all strings and are
	the column titles of the output CSV.
..- BASE_COL_NAME, default 'original_image_path'
..- CROP_COL_NAME, default 'cropped_image_path'
..- SPECIES_COL_NAME, default 'species'
..- BB_CONF_COL_NAME, default 'bb_conf'
..- ENT_COL_NAME, default 'class_ent'

You can define your own function that pre-processes the images
before they are passed into the model by overwriting the main
function of the preprocess_image module. By default, the function
will pre-process images for the default model and so it is important
that this function be changed should you use your own model instead.

The pre-processesing function must
input and output precisely one Tensorflow image tensor or otherwise
will likely cause an error. An example of a function that performs
no pre-processing can be seen below.

```python
from classify_animals.scripts import preprocess_image

preprocess_image.main = lambda x : x

classy_func(
    bb_results_path = 'path\to\MegaDetector\output\json\string', 
    image_dir = 'path\to\raw\images',
    model_path = 'path\to\trained\model'
)
```


## Citation

In accordance with the [licensing agreement](LICENCE.txt), you must
give appropriate credit to the **author** for any work derived from 
this package. When citing this package, please provide the URL of 
this GitHub page, a link to the [licence](LICENCE.txt) and indicate
if any changes to the were made.
You may do so in any reasonable manner, but not in any way that 
suggests the licensor endorses you or your use.

## Acknowledgements 

[//]: # (thank the people who provided the data?)
[//]: # Acknowledge that some of the code and that
[//]: # the idea for the pipeline came from Megadetector
